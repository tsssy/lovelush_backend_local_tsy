<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>Soketi ç§èŠæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        #chat {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: scroll;
            margin-bottom: 10px;
            padding: 5px;
        }

        #message {
            width: 70%;
        }
    </style>
</head>

<body>
    <h2>FastAPI + Soketi ç§èŠæµ‹è¯•</h2>
    <div style="margin-bottom: 10px;">
        <label>ç”¨æˆ·å: <input id="loginUsername" type="text" placeholder="alice" /></label>
        <label style="margin-left: 10px;">å¯†ç : <input id="loginPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" /></label>
        <button id="loginBtn" type="button" onclick="loginAndFill()">ç™»å½•å¹¶è·å–JWT</button>
    </div>
    <div>
        <label>å½“å‰ç”¨æˆ·ID: <input id="userId" type="text" placeholder="ä¾‹å¦‚ 1" /></label>
    </div>
    <div>
        <label>ç›®æ ‡ç”¨æˆ·ID: <input id="toUserId" type="text" placeholder="ä¾‹å¦‚ 2" /></label>
    </div>
    <div>
        <label>JWT Token: <input id="jwt" type="text" placeholder="Bearer ..." style="width:400px;" /></label>
    </div>

    <div id="chat"></div>

    <input id="message" type="text" placeholder="è¾“å…¥æ¶ˆæ¯..." />
    <button id="send">å‘é€</button>

    <script src="https://cdn.jsdelivr.net/npm/pusher-js@7.2.0/dist/web/pusher.min.js"></script>
    <script>
        let pusher, channel;

        const chatBox = document.getElementById("chat");
        const sendBtn = document.getElementById("send");

        function logMessage(msg, type = 'info') {
            const div = document.createElement("div");
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if (type === 'error') div.style.color = 'red';
            if (type === 'success') div.style.color = 'green';
            if (type === 'warning') div.style.color = 'orange';
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        async function loginAndFill() {
            logMessage("ğŸ–±ï¸ ç‚¹å‡»äº†ç™»å½•æŒ‰é’®ï¼Œå¼€å§‹è¯·æ±‚...", 'info');

            const username = document.getElementById("loginUsername").value.trim();
            const password = document.getElementById("loginPassword").value.trim();
            if (!username || !password) {
                logMessage("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ", 'warning');
                return;
            }

            try {
                // â¬‡ï¸ Use form-encoded body (most FastAPI login endpoints expect this)
                const form = new URLSearchParams();
                form.set("username", username);
                form.set("password", password);
                // If your backend uses OAuth2PasswordRequestForm strictly, uncomment:
                // form.set("grant_type", "password");
                // form.set("scope", "");
                // form.set("client_id", "");
                // form.set("client_secret", "");

                const resp = await fetch("http://127.0.0.1:8000/api/v1/auth/login", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "Accept": "application/json"
                    },
                    body: form.toString()
                });

                const result = await resp.json();

                if (!resp.ok) {
                    const errMsg = result?.msg || result?.detail || `HTTP ${resp.status}`;
                    logMessage(`âŒ ç™»å½•å¤±è´¥: ${errMsg}`, 'error');
                    return;
                }

                // Expecting { code, msg, data: {...} }
                if (!result || typeof result !== "object" || !result.data) {
                    logMessage("âŒ ç™»å½•è¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼ˆç¼ºå°‘ dataï¼‰", 'error');
                    return;
                }

                const data = result.data;
                const token = data.access_token;
                const userId = data.user.id;

                if (!token) {
                    logMessage("âŒ æœªä»è¿”å›ä¸­è·å–åˆ° tokenï¼ˆaccess_token/tokenï¼‰", 'error');
                    return;
                }
                if (!userId) {
                    logMessage("âŒ æœªä»è¿”å›ä¸­è·å–åˆ°ç”¨æˆ·IDï¼ˆuser_id/id/uidï¼‰", 'error');
                    return;
                }

                const jwtInput = document.getElementById("jwt");
                const userIdInput = document.getElementById("userId");
                jwtInput.value = token.startsWith("Bearer ") ? token : `Bearer ${token}`;
                userIdInput.value = userId;

                logMessage(`âœ… ç™»å½•æˆåŠŸï¼ˆuser_id=${userId}ï¼‰ã€‚å·²å¡«å…… JWT å’Œ ç”¨æˆ·IDã€‚`, 'success');

                // è‡ªåŠ¨åˆå§‹åŒ– Pusher
                initPusher();
            } catch (e) {
                logMessage(`âŒ ç™»å½•è¯·æ±‚å¼‚å¸¸: ${e.message}`, 'error');
            }
        }
        // åˆå§‹åŒ–è¿æ¥
        function initPusher() {
            const userId = document.getElementById("userId").value.trim();
            const jwt = document.getElementById("jwt").value.trim();

            if (!userId || !jwt) {
                logMessage("è¯·è¾“å…¥ ç”¨æˆ·ID å’Œ JWT Token", 'warning');
                return;
            }

            if (pusher) {
                pusher.disconnect();
            }

            logMessage("ğŸ”„ åˆå§‹åŒ– Pusher è¿æ¥...");

            pusher = new Pusher("app-key", {
                wsHost: "127.0.0.1",
                wsPort: 6001,
                forceTLS: false,
                enabledTransports: ["ws"],
                disableStats: true,
                authorizer: (channel, options) => ({
                    authorize: async (socketId, callback) => {
                        try {
                            const jwtInput = document.getElementById("jwt").value.trim();
                            const token = jwtInput.startsWith('Bearer ') ? jwtInput : `Bearer ${jwtInput}`;
                            const resp = await fetch("http://127.0.0.1:8000/api/v1/pusher/auth", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "Accept": "application/json",
                                    "Authorization": token
                                },
                                body: JSON.stringify({
                                    channel_name: channel.name,
                                    socket_id: socketId
                                })
                            });
                            const json = await resp.json();
                            if (!resp.ok) {
                                const errMsg = json?.msg || json?.detail || `HTTP ${resp.status}`;
                                logMessage(`âŒ è®¤è¯å¤±è´¥: ${errMsg}`, 'error');
                                return callback(new Error(errMsg), null);
                            }
                            // å…¼å®¹åç«¯åŒ…è£…ï¼š{code,msg,data:{auth, channel_data?}}
                            const payload = json?.data || json;
                            if (!payload?.auth) {
                                logMessage(`âŒ è®¤è¯è¿”å›ç¼ºå°‘ auth å­—æ®µ: ${JSON.stringify(json)}`, 'error');
                                return callback(new Error("Missing auth in response"), null);
                            }
                            callback(null, payload);
                        } catch (e) {
                            logMessage(`âŒ è®¤è¯å¼‚å¸¸: ${e.message}`, 'error');
                            callback(e, null);
                        }
                    }
                })
            });

            // è¿æ¥çŠ¶æ€äº‹ä»¶
            pusher.connection.bind('connecting', () => {
                logMessage("ğŸ”— æ­£åœ¨è¿æ¥åˆ° Soketi...", 'info');
            });

            pusher.connection.bind('connected', () => {
                logMessage("âœ… å·²è¿æ¥åˆ° Soketi", 'success');
                logMessage(`Socket ID: ${pusher.connection.socket_id}`, 'info');
            });

            pusher.connection.bind('disconnected', () => {
                logMessage("âŒ è¿æ¥å·²æ–­å¼€", 'error');
            });

            pusher.connection.bind('error', (err) => {
                logMessage(`âŒ è¿æ¥é”™è¯¯: ${JSON.stringify(err)}`, 'error');
            });

            pusher.connection.bind('failed', (err) => {
                logMessage(`âŒ è¿æ¥å¤±è´¥: ${JSON.stringify(err)}`, 'error');
            });

            // è®¢é˜…å½“å‰ç”¨æˆ·çš„ç§æœ‰é¢‘é“
            const channelName = `private-user-${userId}`;
            logMessage(`ğŸ”” è®¢é˜…é¢‘é“: ${channelName}`);

            channel = pusher.subscribe(channelName);

            channel.bind('pusher:subscription_succeeded', () => {
                logMessage(`âœ… æˆåŠŸè®¢é˜…é¢‘é“: ${channelName}`, 'success');
            });

            channel.bind('pusher:subscription_error', (err) => {
                logMessage(`âŒ è®¢é˜…å¤±è´¥: ${JSON.stringify(err)}`, 'error');
            });

            channel.bind("new_message", (data) => {
                logMessage(`ğŸ“¨ [æ”¶åˆ°æ¶ˆæ¯] ${data.from_user_id} -> ${data.to_user_id}: ${data.body}`, 'success');
            });
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const toUserId = document.getElementById("toUserId").value.trim();
            const message = document.getElementById("message").value.trim();
            const jwt = document.getElementById("jwt").value.trim();

            if (!toUserId || !message || !jwt) {
                logMessage("è¯·è¾“å…¥ ç›®æ ‡ç”¨æˆ·IDã€æ¶ˆæ¯ å’Œ JWT Token", 'warning');
                return;
            }

            try {
                logMessage(`ğŸ“¤ å‘é€æ¶ˆæ¯ç»™ç”¨æˆ· ${toUserId}: ${message}`, 'info');

                const response = await fetch(`http://127.0.0.1:8000/api/v1/pusher/messages/private/${toUserId}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": jwt.startsWith('Bearer ') ? jwt : `Bearer ${jwt}`
                    },
                    body: JSON.stringify({
                        body: message,
                        client_msg_id: Date.now().toString()
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    logMessage(`âœ… æ¶ˆæ¯å‘é€æˆåŠŸ: ${result.msg}`, 'success');
                    document.getElementById("message").value = "";
                } else {
                    logMessage(`âŒ å‘é€å¤±è´¥: ${result.msg || result.detail}`, 'error');
                }
            } catch (error) {
                logMessage(`âŒ å‘é€é”™è¯¯: ${error.message}`, 'error');
            }
        }

        sendBtn.onclick = sendMessage;

        // å›è½¦å‘é€
        document.getElementById("message").addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
                sendMessage();
            }
        });

        // é¡µé¢åŠ è½½åç»‘å®šäº‹ä»¶
        window.onload = () => {
            document.getElementById("userId").addEventListener("change", initPusher);
            document.getElementById("jwt").addEventListener("change", initPusher);

            // æ·»åŠ æ‰‹åŠ¨è¿æ¥æŒ‰é’®
            const connectBtn = document.createElement("button");
            connectBtn.textContent = "æ‰‹åŠ¨è¿æ¥";
            connectBtn.onclick = initPusher;
            document.body.insertBefore(connectBtn, document.getElementById("chat"));

            // ç»‘å®šç™»å½•æŒ‰é’®
            const loginBtn = document.getElementById("loginBtn");
            if (loginBtn) loginBtn.onclick = loginAndFill;

            // å¯†ç è¾“å…¥å›è½¦ç›´æ¥ç™»å½•
            const pwd = document.getElementById("loginPassword");
            if (pwd) {
                pwd.addEventListener("keypress", (e) => {
                    if (e.key === "Enter") loginAndFill();
                });
            }

            logMessage("ğŸš€ é¡µé¢å·²åŠ è½½ï¼šå¯å…ˆç™»å½•è·å– JWTï¼ˆè‡ªåŠ¨å¡«å…¥ï¼‰å†è¿æ¥ï¼›æˆ–æ‰‹åŠ¨å¡«å…¥ JWT/ç”¨æˆ·ID åç‚¹å‡»æ‰‹åŠ¨è¿æ¥ã€‚", 'info');
        };

    </script>
</body>

</html>
