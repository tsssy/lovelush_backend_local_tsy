<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoveLush Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 10px;
            font-size: 24px;
        }

        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 500;
        }

        .status.loading {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .user-info {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .user-info h3 {
            margin-bottom: 15px;
            color: var(--tg-theme-text-color, #000000);
        }

        .info-item {
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-item strong {
            color: var(--tg-theme-text-color, #000000);
        }

        .controls {
            margin: 20px 0;
        }

        .btn {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            width: 100%;
            margin: 10px 0;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.8;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .debug-info {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .token-display {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üå∏ LoveLush Mini App</h1>
            <p>Welcome to your personal profile dashboard!</p>
        </div>

        <div id="status" class="status loading">
            Initializing...
        </div>

        <div id="token-section" style="display: none;">
            <h3>üîë Access Token</h3>
            <div id="token-display" class="token-display"></div>
        </div>

        <div id="user-info" class="user-info" style="display: none;">
            <h3>üë§ Your Profile</h3>
            <div id="user-details"></div>
        </div>

        <div class="controls">
            <button id="test-api-btn" class="btn" onclick="testAPI()">
                üîó Test Backend API
            </button>
            <button id="refresh-token-btn" class="btn" onclick="refreshToken()" style="display: none;">
                üîÑ Refresh Token
            </button>
        </div>

        <div id="debug-info" class="debug-info"></div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            // Update this with your actual backend ngrok URL
            BACKEND_URL: 'http://localhost:8000',
            API_BASE: '/api/v1'
        };

        // Global state
        let currentToken = null;
        let refreshToken = null;
        let userInfo = null;

        // DOM elements
        const statusEl = document.getElementById('status');
        const tokenSectionEl = document.getElementById('token-section');
        const tokenDisplayEl = document.getElementById('token-display');
        const userInfoEl = document.getElementById('user-info');
        const userDetailsEl = document.getElementById('user-details');
        const refreshTokenBtnEl = document.getElementById('refresh-token-btn');
        const debugEl = document.getElementById('debug-info');
        const testApiBtnEl = document.getElementById('test-api-btn');

        // Utility functions
        function updateStatus(message, type = 'loading') {
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function updateDebugInfo(info) {
            debugEl.textContent = JSON.stringify(info, null, 2);
        }

        function displayToken(token) {
            if (token) {
                tokenDisplayEl.textContent = `${token.substring(0, 20)}...${token.substring(token.length - 20)}`;
                tokenSectionEl.style.display = 'block';
            }
        }

        function displayUserInfo(user) {
            if (!user) return;

            const details = `
                <div class="info-item"><strong>ID:</strong> ${user.id || 'N/A'}</div>
                <div class="info-item"><strong>Username:</strong> ${user.username || 'N/A'}</div>
                <div class="info-item"><strong>Full Name:</strong> ${user.full_name || 'N/A'}</div>
                <div class="info-item"><strong>Email:</strong> ${user.email || 'N/A'}</div>
                <div class="info-item"><strong>Bio:</strong> ${user.bio || 'N/A'}</div>
                <div class="info-item"><strong>Telegram ID:</strong> ${user.telegram_id || 'N/A'}</div>
                <div class="info-item"><strong>Active:</strong> ${user.is_active ? 'Yes' : 'No'}</div>
                <div class="info-item"><strong>Verified:</strong> ${user.is_verified ? 'Yes' : 'No'}</div>
                <div class="info-item"><strong>Created:</strong> ${user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A'}</div>
                <div class="info-item"><strong>Last Login:</strong> ${user.last_login ? new Date(user.last_login).toLocaleDateString() : 'N/A'}</div>
            `;

            userDetailsEl.innerHTML = details;
            userInfoEl.style.display = 'block';
        }

        // Token management
        function getTokenFromURL() {
            // Legacy: Check URL parameters for backward compatibility
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('token');
        }

        function saveTokensToStorage(accessToken, refreshTokenValue = null) {
            if (accessToken) {
                localStorage.setItem('access_token', accessToken);
                currentToken = accessToken;
            }
            if (refreshTokenValue) {
                localStorage.setItem('refresh_token', refreshTokenValue);
                refreshToken = refreshTokenValue;
            }
        }

        function loadTokensFromStorage() {
            currentToken = localStorage.getItem('access_token');
            refreshToken = localStorage.getItem('refresh_token');
            return { accessToken: currentToken, refreshToken };
        }

        // API calls
        async function makeAPICall(endpoint, options = {}) {
            const url = `${CONFIG.BACKEND_URL}${CONFIG.API_BASE}${endpoint}`;

            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(currentToken && { 'Authorization': `Bearer ${currentToken}` })
                }
            };

            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: { ...defaultOptions.headers, ...options.headers }
            };

            try {
                const response = await fetch(url, finalOptions);
                const data = await response.json();

                return {
                    ok: response.ok,
                    status: response.status,
                    data
                };
            } catch (error) {
                return {
                    ok: false,
                    status: 0,
                    error: error.message
                };
            }
        }

        async function getUserProfile() {
            updateStatus('Fetching user profile...', 'loading');
            const result = await makeAPICall('/users/me');

            if (result.ok && result.data?.success) {
                userInfo = result.data.data;
                displayUserInfo(userInfo);
                updateStatus('‚úÖ Profile loaded successfully!', 'success');
                return true;
            } else {
                updateStatus(`‚ùå Failed to load profile: ${result.data?.message || result.error || 'Unknown error'}`, 'error');
                return false;
            }
        }

        async function refreshToken() {
            if (!refreshToken) {
                updateStatus('‚ùå No refresh token available', 'error');
                return false;
            }

            updateStatus('Refreshing token...', 'loading');
            const result = await makeAPICall('/auth/refresh', {
                method: 'POST',
                body: JSON.stringify({ refresh_token: refreshToken })
            });

            if (result.ok && result.data?.success) {
                const newAccessToken = result.data.data.access_token;
                saveTokensToStorage(newAccessToken);
                displayToken(newAccessToken);
                updateStatus('‚úÖ Token refreshed successfully!', 'success');
                refreshTokenBtnEl.style.display = 'block';
                return true;
            } else {
                updateStatus(`‚ùå Failed to refresh token: ${result.data?.message || result.error || 'Unknown error'}`, 'error');
                return false;
            }
        }

        // New: Telegram authentication using initData
        async function authenticateWithTelegram() {
            if (!window.Telegram?.WebApp?.initDataUnsafe) {
                return { success: false, error: 'No Telegram WebApp data available' };
            }

            const initDataUnsafe = window.Telegram.WebApp.initDataUnsafe;
            const initData = window.Telegram.WebApp.initData; // Raw initData string for verification

            // Extract user info from Telegram
            const telegramUser = initDataUnsafe.user;
            if (!telegramUser) {
                return { success: false, error: 'No user data in Telegram WebApp' };
            }

            // Get start_param (no longer used for tokens, but available for other data)
            const startParam = initDataUnsafe.start_param;

            const authData = {
                telegram_init_data: initData, // For backend verification
                telegram_user: telegramUser
                // Note: start_param no longer needed for auth
            };

            // Call our new Telegram auth endpoint
            const result = await makeAPICall('/auth/telegram', {
                method: 'POST',
                body: JSON.stringify(authData)
            });

            return result;
        }

        async function testAPI() {
            testApiBtnEl.disabled = true;
            testApiBtnEl.textContent = 'üîÑ Testing...';

            const success = await getUserProfile();

            testApiBtnEl.disabled = false;
            testApiBtnEl.textContent = 'üîó Test Backend API';

            if (!success && refreshToken) {
                // Try refreshing token if the API call failed
                const refreshSuccess = await refreshToken();
                if (refreshSuccess) {
                    // Retry the API call
                    await getUserProfile();
                }
            }
        }

        // Telegram WebApp integration
        function initTelegramWebApp() {
            const debugInfo = {
                isWebApp: !!window.Telegram?.WebApp,
                webAppData: window.Telegram?.WebApp ? {
                    initData: window.Telegram.WebApp.initData,
                    initDataUnsafe: window.Telegram.WebApp.initDataUnsafe,
                    version: window.Telegram.WebApp.version,
                    platform: window.Telegram.WebApp.platform,
                    colorScheme: window.Telegram.WebApp.colorScheme,
                    themeParams: window.Telegram.WebApp.themeParams,
                    isExpanded: window.Telegram.WebApp.isExpanded,
                    viewportHeight: window.Telegram.WebApp.viewportHeight,
                    viewportStableHeight: window.Telegram.WebApp.viewportStableHeight,
                    headerColor: window.Telegram.WebApp.headerColor,
                    backgroundColor: window.Telegram.WebApp.backgroundColor
                } : null,
                url: window.location.href,
                userAgent: navigator.userAgent
            };

            updateDebugInfo(debugInfo);

            if (window.Telegram?.WebApp) {
                // Initialize Telegram WebApp
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();

                // Set theme
                if (window.Telegram.WebApp.themeParams) {
                    document.documentElement.style.setProperty('--tg-color-scheme', window.Telegram.WebApp.colorScheme);
                }

                return window.Telegram.WebApp.initData;
            }

            return null;
        }

        // Main initialization
        async function init() {
            updateStatus('üöÄ Starting Mini App...', 'loading');

            // Initialize Telegram WebApp
            const initData = initTelegramWebApp();

            let token = null;

            // Priority 1: Check URL parameters (legacy support)
            const urlToken = getTokenFromURL();
            if (urlToken) {
                token = urlToken;
                updateStatus('‚úÖ Token from URL parameters', 'success');
            }
            // Priority 2: Check storage
            else {
                const { accessToken } = loadTokensFromStorage();
                if (accessToken) {
                    token = accessToken;
                    updateStatus('‚úÖ Token from storage', 'success');
                }
                // Priority 3: Authenticate with Telegram (recommended flow)
                else if (window.Telegram?.WebApp?.initDataUnsafe) {
                    updateStatus('üîê Authenticating with Telegram...', 'loading');
                    const authResult = await authenticateWithTelegram();

                    if (authResult.ok && authResult.data?.success) {
                        const authData = authResult.data.data;
                        token = authData.access_token;
                        saveTokensToStorage(authData.access_token, authData.refresh_token);
                        updateStatus('‚úÖ Authenticated with Telegram initData!', 'success');
                    } else {
                        updateStatus(`‚ùå Telegram auth failed: ${authResult.data?.message || authResult.error}`, 'error');
                        return;
                    }
                } else {
                    updateStatus('‚ùå No authentication method available', 'error');
                    return;
                }
            }

            // Save and display the token
            if (token) {
                saveTokensToStorage(token);
                displayToken(token);
            }

            // Show refresh button if we have a refresh token
            if (refreshToken) {
                refreshTokenBtnEl.style.display = 'block';
            }

            // Test API connection
            await testAPI();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
